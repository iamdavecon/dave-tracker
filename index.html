<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nearby Viewers Game</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --fg:#eaf0ff; --muted:#9fb0ff; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); display:flex; min-height:100vh; }
    .wrap { margin:auto; width:min(720px, 92vw); display:grid; gap:16px; }
    .card { background: var(--card); border-radius:20px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin:0; font-weight:800; letter-spacing:0.5px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button { background:#4c6fff; color:white; border:0; padding:12px 16px; border-radius:14px; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    select { background:#1a2447; color:var(--fg); border:1px solid #2a3a75; padding:10px; border-radius:10px; }
    .pill { background:#18224a; color:#cfe0ff; padding:6px 10px; border-radius:999px; font-size:12px; }
    .count { font-size:72px; font-weight:900; line-height:1; letter-spacing:1px; }
    .sub { color: var(--muted); }
    .achievements { display:flex; gap:8px; flex-wrap:wrap; }
    .badge { background:#162043; border:1px solid #2a3a75; padding:8px 10px; border-radius:12px; font-size:13px; }
    .notice { font-size:12px; color:#b7c6ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Nearby Viewers</h1>
      <p class="sub">See how many people viewing <span id="site"></span> are near you—no raw GPS leaves your device.</p>
      <div class="row">
        <label for="radius">Radius</label>
        <select id="radius">
          <option value="200">~200 m</option>
          <option value="500" selected>~500 m</option>
          <option value="1000">~1 km</option>
          <option value="2000">~2 km</option>
        </select>
        <button id="join">Join the swarm</button>
        <span id="status" class="pill">idle</span>
      </div>
    </div>

    <div class="card">
      <div class="count" id="count">–</div>
      <div class="sub">people near you on this site</div>
      <div class="achievements" id="achievements"></div>
    </div>

    <div class="card">
      <div class="notice">
        <strong>Privacy:</strong> Your browser snaps your GPS to a coarse grid cell (based on radius) and only shares that **cell id** + an anonymous session. Change radius any time.
      </div>
    </div>
  </div>

  <script>
    const WS_URL = 'ws://localhost:8080';

    const els = {
      site: document.getElementById('site'),
      join: document.getElementById('join'),
      radius: document.getElementById('radius'),
      status: document.getElementById('status'),
      count: document.getElementById('count'),
      achievements: document.getElementById('achievements'),
    };

    const state = {
      ws: null,
      siteId: `${location.origin}${location.pathname}`,
      lat: null,
      lon: null,
      gridMeters: 500,
      cellId: null,
      streak: 0,
      best: 0,
    };

    els.site.textContent = state.siteId;

    function setStatus(text) { els.status.textContent = text; }

    function toCellId(lat, lon, meters) {
      const latDeg = meters / 111320;
      const lonDeg = meters / (111320 * Math.max(Math.cos(lat * Math.PI/180), 0.1));
      const y = Math.floor(lat / latDeg);
      const x = Math.floor(lon / lonDeg);
      return `${meters}|${y}|${x}`;
    }

    function connect() {
      if (state.ws && state.ws.readyState === WebSocket.OPEN) return;
      state.ws = new WebSocket(WS_URL);
      setStatus('connecting…');
      state.ws.onopen = () => {
        setStatus('connected');
        sendJoin();
      };
      state.ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type === 'count') {
            renderCount(msg.count);
          }
        } catch {}
      };
      state.ws.onclose = () => { setStatus('disconnected'); };
      state.ws.onerror = () => setStatus('error');
    }

    function sendJoin() {
      if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return;
      if (!state.cellId) return;
      state.ws.send(JSON.stringify({
        type: 'join',
        siteId: state.siteId,
        gridMeters: state.gridMeters,
        cellId: state.cellId,
      }));
    }

    function sendSwitch() {
      if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return;
      if (!state.cellId) return;
      state.ws.send(JSON.stringify({
        type: 'switch',
        siteId: state.siteId,
        gridMeters: state.gridMeters,
        cellId: state.cellId,
      }));
    }

    function renderCount(n) {
      els.count.textContent = n;
      if (n > state.best) state.best = n;
      if (n > 1) state.streak += 1; else state.streak = 0;
      renderAchievements(n);
    }

    function renderAchievements(n) {
      const items = [];
      if (n >= 2) items.push(`Pair Unlocked`);
      if (n >= 5) items.push(`Hotspot x5`);
      if (n >= 10) items.push(`Party x10`);
      if (state.best >= 20) items.push(`Crowd Surfer (20+)`);
      if (state.streak >= 5) items.push(`Streak ${state.streak}`);
      els.achievements.innerHTML = items.map(t => `<span class="badge">${t}</span>`).join('');
    }

    async function joinFlow() {
      setStatus('locating…');
      const gridMeters = parseInt(els.radius.value, 10);
      state.gridMeters = gridMeters;

      try {
        const pos = await new Promise((resolve, reject) =>
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: false, timeout: 10000, maximumAge: 300000
          })
        );
        state.lat = pos.coords.latitude;
        state.lon = pos.coords.longitude;
        state.cellId = toCellId(state.lat, state.lon, state.gridMeters);
        connect();
      } catch (e) {
        setStatus('location denied');
        alert('We need approximate location to show nearby viewers.');
      }
    }

    els.join.addEventListener('click', joinFlow);

    els.radius.addEventListener('change', () => {
      if (state.lat == null) return;
      state.gridMeters = parseInt(els.radius.value, 10);
      state.cellId = toCellId(state.lat, state.lon, state.gridMeters);
      if (state.ws && state.ws.readyState === WebSocket.OPEN) sendSwitch();
    });
  </script>
</body>
</html>
